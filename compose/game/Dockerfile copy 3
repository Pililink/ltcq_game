FROM ubuntu:20.04

# 环境变量设置
ENV DEBIAN_FRONTEND=noninteractive
ENV MYSQL_ROOT_PASSWORD=123456

# 更新软件源并安装所需的软件包
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    libncurses5-dev \
    libssl-dev \
    bison \
    wget \
    curl \
    lsb-release \
    apt-transport-https \
    libaio-dev \
    libboost-dev \
    nginx \
    software-properties-common

# 添加 PHP 5.6 源并安装 PHP 5.6 及常用扩展
RUN add-apt-repository ppa:ondrej/php && apt-get update && apt-get install -y \
    php5.6 \
    php5.6-fpm \
    php5.6-mysql \
    php5.6-cli \
    php5.6-common \
    php5.6-json \
    php5.6-opcache \
    php5.6-readline

# # 下载并编译安装 MySQL 5.6
WORKDIR /usr/src
RUN wget https://downloads.mysql.com/archives/get/p/23/file/mysql-5.6.51.tar.gz && \
    tar -xzf mysql-5.6.51.tar.gz && \
    mkdir -p mysql-5.6.51/bld &&\
    mkdir -p /data/mysql &&\


    cd mysql-5.6.51/bld &&\
    cmake .. \
    -DCMAKE_INSTALL_PREFIX=/usr/local/mysql \
    -DMYSQL_DATADIR=/data/mysql \
    -DSYSCONFDIR=/etc && \
    make && make install  && \
    rm -rf /usr/src/mysql*

RUN groupadd mysql && useradd -r -g mysql mysql && \
    chown -R mysql:mysql /data/mysql && \
    cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysql

RUN echo 'PATH=/usr/local/mysql/bin:/usr/local/mysql/lib:\$PATH' >> /etc/profile
RUN /usr/local/mysql/scripts/mysql_install_db --user=mysql --basedir=/usr/local/mysql --datadir=/data/mysql && \
    cp /usr/local/mysql/support-files/my-default.cnf /etc/my.cnf && \
    sed -i 's/bind-address.*/bind-address = 0.0.0.0/' /etc/my.cnf && \
    chmod +x /etc/init.d/mysql && \
    update-rc.d mysql defaults

# 设置 Nginx 和 PHP-FPM 服务自动启动
RUN systemctl enable nginx && systemctl enable php5.6-fpm && systemctl enable mysql

# 开放 Nginx 和 MySQL 的默认端口
EXPOSE 80 3306

# 启动 Nginx、PHP-FPM 和 MySQL 服务
CMD service nginx start && service php5.6-fpm start && service mysql start && tail -f /dev/null
