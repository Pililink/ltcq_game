FROM ubuntu:20.04

# 环境变量设置
ENV DEBIAN_FRONTEND=noninteractive \
    MYSQL_ROOT_PASSWORD=123456 \
    MYSQL_VERSION=5.6.51 \
    INIT_SQL_DIR=/docker-entrypoint-initdb.d

    
COPY ./src /ltcq
COPY ./init-sql /docker-entrypoint-initdb.d
COPY docker-entrypoint.sh /usr/local/bin/

# 更新软件源并安装所需的软件包
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    cmake \
    libncurses5-dev \
    libssl-dev \
    bison \
    wget \
    curl \
    lsb-release \
    apt-transport-https \
    libaio-dev \
    libboost-dev \
    nginx \
    software-properties-common && \
    add-apt-repository ppa:ondrej/php && apt-get update && apt-get install -y --no-install-recommends \
    php5.6 \
    php5.6-fpm \
    php5.6-mysql \
    php5.6-cli \
    php5.6-common \
    php5.6-json \
    php5.6-opcache \
    php5.6-readline && \
    cd /usr/src && \
    rm -rf mysql-${MYSQL_VERSION}.tar.gz mysql-${MYSQL_VERSION} && \
    rm -rf /usr/src/mysql*

# 下载并编译安装 MySQL 5.6
WORKDIR /usr/src
RUN wget https://downloads.mysql.com/archives/get/p/23/file/mysql-${MYSQL_VERSION}.tar.gz && \
    tar -xzf mysql-${MYSQL_VERSION}.tar.gz && \
    mkdir -p mysql-${MYSQL_VERSION}/bld /data/mysql && \
    cd mysql-${MYSQL_VERSION}/bld && \
    cmake .. \
    -DCMAKE_INSTALL_PREFIX=/usr/local/mysql \
    -DMYSQL_DATADIR=/data/mysql \
    -DSYSCONFDIR=/etc && \
    make -j$(nproc) && make install && \
    rm -rf /usr/src/mysql*

# 设置 MySQL 用户组、权限和配置文件
RUN groupadd mysql && useradd -r -g mysql mysql && \
    chown -R mysql:mysql /data/mysql && \
    cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysql && \
    /usr/local/mysql/scripts/mysql_install_db --user=mysql --basedir=/usr/local/mysql --datadir=/data/mysql && \
    cp /usr/local/mysql/support-files/my-default.cnf /etc/my.cnf && \
    sed -i 's/bind-address.*/bind-address = 0.0.0.0/' /etc/my.cnf && \
    chmod +x /etc/init.d/mysql && \
    update-rc.d mysql defaults

# 设置环境变量
ENV PATH="/usr/local/mysql/bin:/usr/local/mysql/lib:$PATH"

RUN apt-get purge -y --auto-remove && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* /usr/share/man /usr/share/doc /usr/share/doc-base

RUN systemctl enable nginx php5.6-fpm mysql

# 开放 Nginx 和 MySQL 的默认端口
EXPOSE 80 3306

# 启动 Nginx、PHP-FPM 和 MySQL 服务并执行初始化 SQL
CMD ["sh", "-c", "/usr/local/bin/docker-entrypoint.sh && tail -f /dev/null"]
